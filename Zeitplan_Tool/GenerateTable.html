<!DOCTYPE>
<html>
<head><title>Table</title></head>
<script type="text/javascript">
window.onload = function() {

	var json = getEventsJSON();
	var events = JSON.parse(json);
	
	//sorting the event objects 1st Order: date, 2nd Order: time
	events = events.sort(function (a,b) { 
	
		//converts the date and time in a logical integer which we can better compare
		var helper = a.date.trim().split(".");
		var helper2 = a.time.trim().split(":");
		var sortKeyA = helper[2] + helper[1] + helper[0] + helper2[0] + helper2[1];
		var sortKeyAnum = parseInt(sortKeyA);
		
		helper = b.date.trim().split(".");
		helper2 = b.time.trim().split(":");
		var sortKeyB = helper[2] + helper[1] + helper[0] + helper2[0] + helper2[1];
		var sortKeyBnum = parseInt(sortKeyB);
		
		return sortKeyAnum-sortKeyBnum;
	});

	var pageContent = "";
	var eventsSplitDays = splitEvents(events);
	
	for (var i = 0; i < eventsSplitDays.length; i++) {
		//generate the headline of the table
		pageContent = pageContent + "<p>" + "<h2>" +
		"Tagesprogramm f체r den " + eventsSplitDays[i][0].date + "</h2>" + "</p>";
		
		//generate the table itself
		pageContent = pageContent + "<p>" +
			generateTable(eventsSplitDays[i]) + "</p>";
	}
	
	saveTableHTML(pageContent);
	showTable();
}

function generateTable(events) {
	var table = '<table border="1">';
	var tableHead = getTableHead(events); //Its the array of values which are in the headline of the table
	
	table = table + generateTableHead(tableHead);
	table = table + generateTableBody(tableHead, events);
	
	table = table + '</table>';
	
	return table;
}

function generateTableBody(tableHead, events) {
	var tableBody = '';
	
	var groupedEvents = getGroupedEvents(events);
	var rowElements = parseToRowElement(groupedEvents);
	
	for (var i = 0; i < rowElements.length; i++) {
		tableBody = tableBody + getTableRow(rowElements[i], tableHead);
	}

	return tableBody;
}

function parseToRowElement(groupedEvents) {
	var rowElements = [];
	
	for (var i = 0; i < groupedEvents.length; i++) {
	//executed for every group, one group is array of events grouped by the same time
		var currentGroup = groupedEvents[i];
		var rowTime = currentGroup[0].time;
		var rowCells = [];
		for (j = 0; j < currentGroup.length; j++) {
		
			var currentEvent = currentGroup[j];
			for (var k = 0; k < currentEvent.category.length; k++) {
				var currentCell = new Cell(currentEvent.category[k], currentEvent[k]);
				rowCells.push(currentCell);
			}
		}
		// TODO rowCells = shortenCells(rowCells);
		rowElements.push(new RowElement(rowTime, rowCells));
	}
	return rowElements;
}

function shortenCells(rowCells) {
	//TODO
}

function RowElement (time, cells) {
	this.time = time;
	this.cells = cells;
}
function Cell (category, discipline) {
	this.category = category;
	this.discipline = discipline;
}

function getTableRow (rowElement, tableHead) {
	var tableRow = "<tr>";
	tableRow = tableRow + "<td>" + rowElement.time + "</td>";
	
	//var i = 1, because the time is already set
	for (var i = 1; i < tableHead.length; i++) {
		if(false/*Zelle ist vorhanden - 체ber das rowElement.category und tablehead[i] checken*/) {
		
			tableRow = tableRow + "<td>";
			//TODO get content according to the tableCell 
			tableRow = tableRow + "</td>";
		} else {
			tableRow = tableRow + "<td></td>";
		}
	}
	
	tableRow = tableRow + "</tr>";
	
	return tableRow;
}

//returns the events grouped if they are at same time
function getGroupedEvents(events) {
	var splittedEvents = [];
	splittedEvents[0] = [];
	var index = 0;
	
	var currentTime = events[0].time;
	
	for (var i = 0; i<events.length; i++) {
		if (currentTime == events[i].time) {
			splittedEvents[index].push(events[i]);
		} else {
			index = index + 1;
			splittedEvents[index] = [];
			splittedEvents[index].push(events[i]);
			currentTime = events[i].time;
		}
	}
		
	return splittedEvents;
}

function generateTableHead (tableHead) {
	//parses the TableHead array to a HTML string which can be added to the 
	var txt = "<tr>";
	for(var i = 0; i<tableHead.length; i++) {
		txt = txt + "<th>" + tableHead[i] + "</th>";
	}
	txt = txt + "</tr>";
	return txt;
}

function getTableHead(events) {
	//generate the head of the table
	var tableHead = [];
	//def. "Zeit" has always to be there
	tableHead.push('Zeit');
	//get every event
	for (var i = 0; i < events.length; i++) {
	
		var category = events[i].category;
		//get every category of its event
		for (var j = 0; j < category.length; j++) {
			//token = a single category
			var token = category[j];
			
			//check if the single category is already in the tableHead
			var canBeAdded = true;
			for (var k = 0; k < tableHead.length; k++) {
				if(token == tableHead[k]) {
					canBeAdded=false;
				}
			}
			if (canBeAdded) {
				tableHead.push(token);
			}
		}
	}
	
	//sorting the tableHead, female before male, youth before old
	tableHead = tableHead.sort(function (a,b) { 
		//converts the tableHead in a logical integer which we can better compare
		var sortKeyA = getSortKeyTableHead(a);
		var sortKeyB = getSortKeyTableHead(b);
		
		return sortKeyA-sortKeyB;
	});
	
	return tableHead;
}

function getSortKeyTableHead(token) {
	//Key for "Zeit" has to stay at the left border...
	if(token == "Zeit") {
		return 0;
	}

	//Keys for the main classes
	if (token == 'Frauen') {
		return 200;
	} else if (token == 'M채nner') {
		return 600;
	} 	
	
	//Keys for the youth
	if (token.includes('WU')) {
		var val = 100;
		val = val + parseInt(token.slice(2));
		return val;
	} else if (token.includes('MU')) {
		var val = 500;
		val = val + parseInt(token.slice(2));
		return val;
	}

/*	
	//Keys for the old generation
	if (token.includes('W')) {
		var val = 300;
		val = val + parseInt(token.slice(1));
	} else if (token.includes('M')&&(token != 'M채nner') {
		var val = 700;
		val = val + parseInt(token.slice(1));
	}
*/
	return 1;
}

function splitEvents(events) {
	var returnArray = [];
	returnArray[0] = [];
	
	var indexReturnArray = 0;
	var currentDate = events[0].date;
	
	for (var i = 0; i<events.length; i++) {		
		if (events[i].date == currentDate) {
			returnArray[indexReturnArray].push(events[i]);
		} else {
			indexReturnArray = indexReturnArray + 1;
			returnArray[indexReturnArray] = [];
			returnArray[indexReturnArray].push(events[i]);
			currentDate = events[i].date;
		}
	}
	return returnArray;
}

//puts text in the HTML below "<pre id="displayArea"><pre>"
function showTable() {
    var area = document.getElementById('displayArea');
	area.innerHTML = sessionStorage.getItem('table');
}

//saves the tabel content should be executed before saving the text
function saveTableHTML(table) {
	sessionStorage.getItem('table');
	sessionStorage.setItem('table',table);
}

//returns the events in JSON format from the Cleaner before
function getEventsJSON() {
	return sessionStorage.getItem('events');
}
</script>
<body id="body">
<pre id="displayArea"><pre>
</body>
</html>