<!DOCTYPE>
<html>
<head><title>Table</title></head>
<script type="text/javascript">
window.onload = function() {

	var json = getEventsJSON();
	var events = JSON.parse(json);
	
	//sorting the event objects 1st Order: date, 2nd Order: time
	events = events.sort(function (a,b) { 
	
		//converts the date and time in a logical integer which we can better compare
		var helper = a.date.trim().split(".");
		var helper2 = a.time.trim().split(":");
		var sortKeyA = helper[2] + helper[1] + helper[0] + helper2[0] + helper2[1];
		var sortKeyAnum = parseInt(sortKeyA);
		
		helper = b.date.trim().split(".");
		helper2 = b.time.trim().split(":");
		var sortKeyB = helper[2] + helper[1] + helper[0] + helper2[0] + helper2[1];
		var sortKeyBnum = parseInt(sortKeyB);
		
		return sortKeyAnum-sortKeyBnum;
	});

	var pageContent = "";
	var eventsSplitDays = splitEvents(events);
	
	for (var i = 0; i < eventsSplitDays.length; i++) {
		//generate the headline of the table
		pageContent = pageContent + "<p>" + "<h2>" +
		"Tagesprogramm für den " + eventsSplitDays[i][0].date + "</h2>" + "</p>";
		
		//generate the table itself
		pageContent = pageContent + "<p>" +
			generateTable(eventsSplitDays[i]) + "</p>";
	}
	
	saveTableHTML(pageContent);
	showTable();
}

function generateTable(events) {
	var table = '<table border="1">';
	var tableHead = getTableHead(events); //Its the array of values which are in the headline of the table
	
	table = table + generateTableHead(tableHead);
	//table = table + generateTableBody(tableHead, events); -> not yet implemented
	
	table = table + '</table>';
	
	return table;
}

function mergeEvents(events) {
	var mergedEvents = [];
	//TODO merge the events -> so we can access it for one row
	//the 
	
	return mergedEvents; //return an object which can be accessed by the category
}

function generateTableBody(tableHead, events) {
	var tableBody = '';
	var rowElements = mergeEvents(events);
	//TODO generate tablebody with the rowElements
	
	return tableBody; //return string
}

function generateTableHead (tableHead) {
	//parses the TableHead array to a HTML string which can be added to the 
	var txt = "<tr>";
	for(var i = 0; i<tableHead.length; i++) {
		txt = txt + "<th>" + tableHead[i] + "</th>";
	}
	txt = txt + "</tr>";
	return txt;
}

function getTableHead(events) {
	//generate the head of the table
	var tableHead = [];
	//get every event
	for (var i = 0; i < events.length; i++) {
	
		var category = events[i].category;
		//get every category of its event
		for (var j = 0; j < category.length; j++) {
			//token = a single category
			var token = category[j];
			
			//check if the single category is already in the tableHead
			var canBeAdded = true;
			for (var k = 0; k < tableHead.length; k++) {
				if(token == tableHead[k]) {
					canBeAdded=false;
				}
			}
			if (canBeAdded) {
				tableHead.push(token);
			}
		}
	}
	
	//sorting the tableHead, female before male, youth before old
	tableHead = tableHead.sort(function (a,b) { 
		//converts the tableHead in a logical integer which we can better compare
		var sortKeyA = getSortKeyTableHead(a);
		var sortKeyB = getSortKeyTableHead(b);
		
		return sortKeyA-sortKeyB;
	});
	
	return tableHead;
}

function getSortKeyTableHead(token) {

	//Keys for the main classes
	if (token == 'Frauen') {
		return 200;
	} else if (token == 'Männer') {
		return 600;
	} 	
	
	//Keys for the youth
	if (token.includes('WU')) {
		var val = 100;
		val = val + parseInt(token.slice(2));
		return val;
	} else if (token.includes('MU')) {
		var val = 500;
		val = val + parseInt(token.slice(2));
		return val;
	}

/*	
	//Keys for the old generation
	if (token.includes('W')) {
		var val = 300;
		val = val + parseInt(token.slice(1));
	} else if (token.includes('M')&&(token != 'Männer') {
		var val = 700;
		val = val + parseInt(token.slice(1));
	}
*/
	return 0;
}

function splitEvents(events) {
	var returnArray = [];
	returnArray[0] = [];
	
	var indexReturnArray = 0;
	var currentDate = events[0].date;
	
	for (var i = 0; i<events.length; i++) {		
		if (events[i].date == currentDate) {
			returnArray[indexReturnArray].push(events[i]);
		} else {
			indexReturnArray = indexReturnArray + 1;
			returnArray[indexReturnArray] = [];
			returnArray[indexReturnArray].push(events[i]);
			currentDate = events[i].date;
		}
	}
	return returnArray;
}
/*
function generateTable(events) {
	//------------------- Start Table Algorithm ------------------------------
	// requires an array of Events called "events" as imput 
	// generates output: called table with a table of the input event array
	var table = '<table border="1">';
	
	//evalutate the oldest possible athlete 
	var oldest = 0;
	for (var i = 0; i < events.length; i++) {
		if(oldest < events[i].category.length) {
			oldest = events[i].category.length;
		}
	}
	
	//generate table head
	table = table + "<tr>" + "<th>" + "Zeit" + "</th>";
	//women side
	for (var i = 0; i < oldest; i++) {
		table = table +
		"<th>" + "Frauen " + i + " " + "</th>";
	}
	//men side
	for (var i = 0; i < oldest; i++) {
		table = table +
		"<th>" + "M&auml;nner " + i + " " + "</th>";
	}
	table = table + "</tr>";
	
	//fill in the content
	for (var i = 0; i < events.length; i++) {
	table = table + "<tr>";
	table = table + "<td>" + events[i].time + " Uhr" + "</td>";
		//female side content
		if (events[i].gender == "Frauen") {
			for (var j = 0; j < oldest; j++) {
				if (events[i].category[j]) {
					table = table + "<td>" + events[i].discipline + "</td>";
				} else {
					table = table + "<td></td>";
				}
			} 
			//empty male side
			for (var j = 0; j < oldest; j++) {
				table = table + "<td></td>";
			}
			
		//male side content
		} else {
			//empty female side
			for (var j = 0; j < oldest; j++) {
				table = table + "<td></td>";
			}
			for (var j = 0; j < oldest; j++) {
				if (events[i].category[j]) {
					table = table + "<td>" + events[i].discipline + "</td>";
				} else {
					table = table + "<td></td>";
				}
			}
		}
	table = table + "</tr>";
	}
	table = table + "</table>";
	
	//----------------------------End Table Algorithm--------------------------------------
	
	return table;
}*/

//puts text in the HTML below "<pre id="displayArea"><pre>"
function showTable() {
    var area = document.getElementById('displayArea');
	area.innerHTML = sessionStorage.getItem('table');
}

//saves the tabel content should be executed before saving the text
function saveTableHTML(table) {
	sessionStorage.getItem('table');
	sessionStorage.setItem('table',table);
}

//returns the events in JSON format from the Cleaner before
function getEventsJSON() {
	return sessionStorage.getItem('events');
}
</script>
<body id="body">
<pre id="displayArea"><pre>
</body>
</html>