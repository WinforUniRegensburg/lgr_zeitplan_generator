<!DOCTYPE>
<html>
<head><title>Cleaner!</title></head>
<script type="text/javascript">
window.onload = function() {

	var json = getParagraphesText();
	var paragraphs = JSON.parse(json);
	
	var txt = ""
	var events = [];
	
	// creates one event object out of a paragraph
	for (var i = 0; i<paragraphs.length; i++) {
	
		//extracts a copy of the first and second line of the paragraph
		var firstLine = paragraphs[i].firstLine;
		var secondLine = paragraphs[i].secondLine;
	
		//get the date from the secondLine
		//TODO Problem small ähnlich wie bei paragraphHandler das +x besser machen, indem man erkennt, dass es sich um ein Datum handelt... 
		//Irgendwie über die Zeichenfolge?
		//Abstimmung mit Gerit
		var dateIndex = secondLine.search('Datum')+7;
		var date = secondLine.slice(dateIndex, dateIndex+10);
		
		//get the time from the secondLine
		//TODO Problem small wie im Block oben
		//Abstimmung mit Gerit
		var timeIndex = secondLine.search('Beginn')+8;
		var time = secondLine.slice(timeIndex);
		
		//get the eventName and cut it out of the firstLine 
		//eventName is supposed to be in round brackets
		//
		//
		//  ----------------------------------->   TODO Problem BIG IMPORTANT  <--------------------------------------
		//
		//
		// Es gibt in den Daten die unregelmäßigkeit, dass Teile der ersten Zeile in Klammern stehen, obwohl wir die Veranstaltungsart so ermitteln!
		// Nicht immer ist eine Veranstaltungsart im Datensatz vorhanden!
		// Abstimmung mit Gerit
		var eventName = "";
		if (firstLine.includes("(")) {
			var brokenFirstLineEvent = firstLine.split(" (");
			var brokenFirstLineEventHelper = brokenFirstLineEvent[1].split(")");
			eventName = brokenFirstLineEventHelper[0];			
			firstLine = brokenFirstLineEvent[0] + brokenFirstLineEventHelper[1];
		}
	
		//get the discipline and cut it out of the firstLine
		var brokenFristLineDiscipline = firstLine.split(", ");
		var brokenFirstLineDisciplineHelper = brokenFristLineDiscipline[1].split(" - ");
		firstLine = brokenFirstLineDisciplineHelper[0];
		var discipline = brokenFristLineDiscipline[0] + " " + brokenFirstLineDisciplineHelper[1];
		
		//the gender and category are left in the firstLine
		var brokenFLGender = firstLine.split(" ");
		
		//get the gender of the athletes
		var gender = "";
		for (var j = 0; j < brokenFLGender.length; j++) {
			var token = brokenFLGender[j].trim();
			//TODO Problem wenn die Abfrage auf weiblich fehlschlägt, obwohl es Wettkampf für Frauen war wird auf Männer gesetzt...
			// -> Prüfen ob diese Abfrage richtig arbeitet!!!
			// Abstimmung mit Gerit
			if (token == 'Frauen' || token == 'weibliche' || token == 'weiblich') {
				gender='Frauen';
				break;
			} else {
				gender='Männer'
			}
		}
		
		//get the allowed age of the athletes, if no age is found it will be set to 30
		var maxAge = 0;
		for (var j = 0; j < brokenFLGender.length; j++) {
			var token = brokenFLGender[j];
			if (token.charAt(0) == 'U') {
				var maxAgeLoc = parseInt(token.slice(1));
				if (maxAgeLoc>maxAge) {
					maxAge = maxAgeLoc;
				}
			} 
		} 
		//TODO Problem eher was zum Abstimmen... Was ist das Alter, auf welches wir setzen, wenn mit der Methode oben kein Alter ermittelt wird??
		//Hier als Übergangslösung maxAge auf 30 gesetzt
		//Abstimmung mit Gerit
		if (maxAge == 0) {
			maxAge = 30;
		}
		//creates the categories according to the allowed age
		var category = [];
		for (var j = 0; j < maxAge; j++) {
			category[j] = true;
		}
		
		//collect all evaluated information
		var singleEvent = new Event (	date, 
										time, 
										category,
										discipline, 
										eventName, 
										gender);
										
		//add the singleEvent to the event array
		events.push(singleEvent);
		
		//makes some output for debugging
		txt = txt + 
		singleEvent.date + "<br>" 
		+ singleEvent.time + "<br>" 
		+ singleEvent.eventName + "<br>" 
		+ singleEvent.discipline +"<br>"
		+ singleEvent.gender + "<br>"
		+ singleEvent.category[0] + "<br><br><br>";
	}

	//display debugging output
	document.getElementById('displayArea').innerHTML = txt;

	
	//sorting the event objects 1st Order: date, 2nd Order: time
	events = events.sort(function (a,b) { 
	
		//converts the date and time in a logical integer which we can better compare
		var helper = a.date.trim().split(".");
		var helper2 = a.time.trim().split(":");
		var sortKeyA = helper[2] + helper[1] + helper[0] + helper2[0] + helper2[1];
		var sortKeyAnum = parseInt(sortKeyA);
		
		helper = b.date.trim().split(".");
		helper2 = b.time.trim().split(":");
		var sortKeyB = helper[2] + helper[1] + helper[0] + helper2[0] + helper2[1];
		var sortKeyBnum = parseInt(sortKeyB);
		
		return sortKeyAnum-sortKeyBnum;
	});

	//saves events in the JSON format
	saveJSON(events);
	document.getElementById("submit").submit();
}

//constructor for an event
function Event(date, time, category, discipline, eventName, gender) {

	//TODO Problem Abstimmung mit Gerit
	//zweites Array mit category einfügen, sodass zwischen Männern und Frauen zur gleichen Uhrzeit unterschieden werden könnte
	
	this.date = date;
	this.time = time;
	this.category = category;
	this.discipline = discipline;
	this.eventName = eventName;
	this.gender = gender;
}

//saves the events
function saveJSON(events) {
	var json = JSON.stringify(events);			
	sessionStorage.getItem('events');
	sessionStorage.setItem('events',json);
}

//returns the paragraphText from the Paragraph handler before
function getParagraphesText() {
	return sessionStorage.getItem('paragraphText');
}
</script>
<body id="body">
	<form id="submit" action="GenerateTable.html">
		<input type="submit" id="submitButton" value="weiter" />
	</form>
<pre id="displayArea"><pre>
</form>
</body>
</html>